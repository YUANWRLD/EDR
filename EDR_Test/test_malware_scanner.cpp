#include <pch.h>
#include <gtest/gtest.h>
#include <Windows.h>
#include <vector>
#include <string>

#include "MalwareScanner.h"

class MalwareScannerTest : public ::testing::Test {
protected:
    MalwareScanner* scanner;

    void SetUp() override {
        scanner = new MalwareScanner();
    }

    void TearDown() override {
        delete scanner;
    }

    std::string BuildMalwareSignature() {
        std::string part1 = "BOMBE_";
        std::string part2 = "MAL_";
        std::string part3 = "FLAG_";
        return part1 + part2 + part3;
    }
};

// ------------------------------------------------------------------------
// Test Case 1: 測試掃描不存在的 PID
// ------------------------------------------------------------------------
TEST_F(MalwareScannerTest, ScanInvalidPID) {
    DWORD invalidPid = 999999;

    bool result = scanner->ScanProcessMemory(invalidPid);
    EXPECT_FALSE(result);
}

// ------------------------------------------------------------------------
// Test Case 2: 模擬惡意特徵並掃描 (Infected Scan)
// ------------------------------------------------------------------------
TEST_F(MalwareScannerTest, ScanInfectedSelf) {
    DWORD myPid = GetCurrentProcessId();

    std::string payload = BuildMalwareSignature();
    size_t payloadSize = payload.size();

    void* pMemory = VirtualAlloc(NULL, 1024, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);
    ASSERT_NE(pMemory, nullptr) << "Failed to allocate memory for test.";

    memcpy(pMemory, payload.c_str(), payloadSize);

    bool result = scanner->ScanProcessMemory(myPid);

    EXPECT_TRUE(result) << "Scanner failed to detect injected memory payload.";

    VirtualFree(pMemory, 0, MEM_RELEASE);
}